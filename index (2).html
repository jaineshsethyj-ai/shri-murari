<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gold Rate Updater | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel Standalone to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap');
      
      :root {
        --font-heading: 'Playfair Display', serif;
        --font-body: 'Inter', sans-serif;
      }

      body {
        font-family: var(--font-body);
        background-color: #f7fafc;
      }

      h1, h2, h3, h4, h5, h6 {
        font-family: var(--font-heading);
      }
    </style>
  </head>
  <body class="antialiased">
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    
    <script>
      // IMPORTANT: Replace with your actual Firebase configuration
      const firebaseConfig = {
        apiKey: "YOUR_API_KEY", // Replace with your actual key
        authDomain: "shrimurarirate.firebaseapp.com",
        databaseURL: "https://shrimurarirate-default-rtdb.firebaseio.com",
        projectId: "shrimurarirate",
        storageBucket: "shrimurarirate.appspot.com",
        messagingSenderId: "87052333093",
        appId: "YOUR_APP_ID" // Replace with your actual App ID
      };

      // Initialize Firebase
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
    </script>
    
    <script type="text/babel" data-type="module">
      // De-structure React hooks for convenience
      const { useState, useEffect } = React;

      // === services/firebaseService.js ===
      const db = firebase.database();
      const dbRef = db.ref("rates");

      const getRates = () => {
        return new Promise((resolve, reject) => {
          dbRef.once('value', (snapshot) => {
            const val = snapshot.val();
            if (val) {
              resolve({
                rate24k: Number(val.rate24k) || 0,
                rate22k: Number(val.rate22k) || 0,
                rate18k: Number(val.rate18k) || 0,
              });
            } else {
              resolve(null); // No data found
            }
          }, (error) => {
            console.error("Firebase read failed:", error);
            reject(error);
          });
        });
      };

      const updateRates = (newRates) => {
        const numericRates = {
          rate24k: Number(newRates.rate24k),
          rate22k: Number(newRates.rate22k),
          rate18k: Number(newRates.rate18k),
        };
        return dbRef.set(numericRates);
      };


      // === components/LoadingSpinner.js ===
      const LoadingSpinner = () => {
        return (
          <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div>
        );
      };

      // === components/LogoIcon.js ===
      const LogoIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
        </svg>
      );
      
      // === components/InputField.js ===
      const InputField = ({ label, name, value, onChange, placeholder }) => {
        return (
          <div>
            <label htmlFor={name} className="block text-sm font-medium text-gray-700 mb-1">
              {label}
            </label>
            <div className="relative">
              <span className="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">â‚¹</span>
              <input
                type="number"
                id={name}
                name={name}
                value={value}
                onChange={onChange}
                placeholder={placeholder}
                className="w-full pl-7 pr-4 py-3 text-lg font-semibold border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition"
                min="0"
                step="any"
                required
              />
            </div>
          </div>
        );
      };

      // === components/LoginPage.js ===
      const LoginPage = ({ onLoginSuccess }) => {
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');

        const handleSubmit = (e) => {
          e.preventDefault();
          if (password === '5555') {
            onLoginSuccess();
          } else {
            setError('Incorrect password. Please try again.');
            setPassword('');
          }
        };

        return (
          <div className="min-h-screen bg-gray-100 flex flex-col items-center justify-center p-4">
            <div className="w-full max-w-sm">
              <header className="text-center mb-8">
                <div className="flex items-center justify-center gap-2">
                  <LogoIcon className="w-8 h-8 text-amber-950" />
                  <div>
                    <h1 className="text-3xl font-bold text-amber-950">
                      Shri Murari Jewellers
                    </h1>
                    <p className="text-sm text-gray-500 tracking-widest -mt-1">RATE UPDATER</p>
                  </div>
                </div>
              </header>

              <main className="bg-white p-8 rounded-2xl shadow-lg">
                <h2 className="text-2xl font-semibold text-center text-gray-800 mb-1">Admin Access</h2>
                <p className="text-center text-gray-500 text-sm mb-6">Enter password to continue.</p>
                <form onSubmit={handleSubmit} className="space-y-6">
                  <div>
                    <label htmlFor="password" className="block text-sm font-medium text-gray-700 sr-only">
                      Password
                    </label>
                    <input
                      id="password"
                      name="password"
                      type="password"
                      autoComplete="current-password"
                      required
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      placeholder="Password"
                      className="w-full px-4 py-3 text-lg font-semibold border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition"
                    />
                  </div>

                  <button
                    type="submit"
                    className="w-full bg-amber-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-900 transition-colors duration-300 focus:outline-none focus:ring-4 focus:ring-amber-800/50"
                  >
                    Login
                  </button>
                </form>
                {error && (
                  <div className="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-center text-sm" role="alert">
                    {error}
                  </div>
                )}
              </main>
            </div>
          </div>
        );
      };

      // === App.js ===
      const App = () => {
        const [isAuthenticated, setIsAuthenticated] = useState(false);
        const [rates, setRates] = useState({ rate24k: 0, rate22k: 0, rate18k: 0 });
        const [initialLoading, setInitialLoading] = useState(true);
        const [isUpdating, setIsUpdating] = useState(false);
        const [error, setError] = useState(null);
        const [success, setSuccess] = useState(null);

        useEffect(() => {
          if (!isAuthenticated) return;

          const fetchInitialRates = async () => {
            setInitialLoading(true);
            try {
              const currentRates = await getRates();
              if (currentRates) {
                setRates(currentRates);
              }
            } catch (err) {
              setError('Failed to fetch current rates. Please check your connection or Firebase configuration.');
            } finally {
              setInitialLoading(false);
            }
          };

          fetchInitialRates();
        }, [isAuthenticated]);

        const handleInputChange = (e) => {
          const { name, value } = e.target;
          setRates(prevRates => ({
            ...prevRates,
            [name]: value === '' ? '' : parseFloat(value)
          }));
        };

        const handleSubmit = async (e) => {
          e.preventDefault();
          setIsUpdating(true);
          setError(null);
          setSuccess(null);

          // Validate that all rates are numbers and not empty
          if (isNaN(rates.rate18k) || isNaN(rates.rate22k) || isNaN(rates.rate24k)) {
              setError("All rate fields must be filled with valid numbers.");
              setIsUpdating(false);
              return;
          }

          try {
            await updateRates(rates);
            setSuccess('Gold rates updated successfully!');
            setTimeout(() => setSuccess(null), 4000);
          } catch (err) {
            setError('An error occurred while updating rates. Please try again.');
            console.error(err);
          } finally {
            setIsUpdating(false);
          }
        };

        const handleLoginSuccess = () => {
          setIsAuthenticated(true);
        };

        if (!isAuthenticated) {
          return <LoginPage onLoginSuccess={handleLoginSuccess} />;
        }

        return (
          <div className="min-h-screen bg-gray-100 flex flex-col items-center justify-center p-4">
            <div className="w-full max-w-md">
              <header className="text-center mb-8">
                <div className="flex items-center justify-center gap-2">
                  <LogoIcon className="w-8 h-8 text-amber-950" />
                  <div>
                    <h1 className="text-3xl font-bold text-amber-950">
                      Shri Murari Jewellers
                    </h1>
                    <p className="text-sm text-gray-500 tracking-widest -mt-1">RATE UPDATER</p>
                  </div>
                </div>
              </header>

              <main className="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                {initialLoading ? (
                  <div className="flex flex-col items-center justify-center h-64">
                    <LoadingSpinner />
                    <p className="text-gray-600 mt-4">Loading Current Rates...</p>
                  </div>
                ) : (
                  <form onSubmit={handleSubmit} className="space-y-6">
                    <h2 className="text-2xl font-semibold text-center text-gray-800">Update Gold Prices</h2>
                    <p className="text-center text-gray-500 text-sm -mt-4">Enter rates per 10 grams.</p>
                    
                    <InputField
                      label="24 Karat (99.9%)"
                      name="rate24k"
                      value={rates.rate24k}
                      onChange={handleInputChange}
                      placeholder="e.g. 72000"
                    />
                    <InputField
                      label="22 Karat (91.6%)"
                      name="rate22k"
                      value={rates.rate22k}
                      onChange={handleInputChange}
                      placeholder="e.g. 68000"
                    />
                    <InputField
                      label="18 Karat (75.0%)"
                      name="rate18k"
                      value={rates.rate18k}
                      onChange={handleInputChange}
                      placeholder="e.g. 58000"
                    />

                    <button
                      type="submit"
                      disabled={isUpdating}
                      className="w-full bg-amber-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-900 transition-colors duration-300 focus:outline-none focus:ring-4 focus:ring-amber-800/50 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center"
                    >
                      {isUpdating ? <LoadingSpinner /> : 'Update Rates'}
                    </button>
                  </form>
                )}

                {error && (
                  <div className="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-center" role="alert">
                    {error}
                  </div>
                )}
                {success && (
                  <div className="mt-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded-lg text-center" role="alert">
                    {success}
                  </div>
                )}
              </main>
            </div>
          </div>
        );
      };

      // === Final Render Call ===
      const rootElement = document.getElementById('root');
      const root = ReactDOM.createRoot(rootElement);
      root.render(<App />);

    </script>
  </body>
</html>
